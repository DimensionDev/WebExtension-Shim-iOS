!function(t,e){(t=t||self).Realm=e()}(this,function(){"use strict";function t(t,e){const n=`please report internal shim error: ${t}`;throw console.error(n),e&&(console.error(`${e}`),console.error(`${e.stack}`)),n}function e(e,n){e||t(n)}function n(t){return t}function r(t,e){const{initRootRealm:n,initCompartment:r,getRealmGlobal:o,realmEvaluate:a}=e,{create:c,defineProperties:i}=Object,s=new Map([["EvalError",EvalError],["RangeError",RangeError],["ReferenceError",ReferenceError],["SyntaxError",SyntaxError],["TypeError",TypeError],["URIError",URIError]]);function u(t,...e){try{return t(...e)}catch(t){if(Object(t)!==t)throw t;let e,n,r;try{e=`${t.name}`,n=`${t.message}`,r=`${t.stack||n}`}catch(t){throw new Error("unknown error")}const o=s.get(e)||Error;try{throw new o(n)}catch(t){throw t.stack=r,t}}}class l{constructor(){throw new TypeError("Realm is not a constructor")}static makeRootRealm(e={}){const r=c(l.prototype);return u(n,t,r,e),r}static makeCompartment(e={}){const n=c(l.prototype);return u(r,t,n,e),n}get global(){return u(o,this)}evaluate(t,e,n={}){return u(a,this,t,e,n)}}return i(l,{toString:{value:()=>"function Realm() { [shim code] }",writable:!1,enumerable:!1,configurable:!0}}),i(l.prototype,{toString:{value:()=>"[object Realm]",writable:!1,enumerable:!1,configurable:!0}}),l}const o=n(`'use strict'; (${r})`);const{assign:a,create:c,freeze:i,defineProperties:s,getOwnPropertyDescriptor:u,getOwnPropertyDescriptors:l,getOwnPropertyNames:f,getPrototypeOf:p,setPrototypeOf:y}=Object,{apply:m,ownKeys:h}=Reflect,d=t=>(e,...n)=>m(t,e,n),w=d(Object.prototype.hasOwnProperty),b=d(Array.prototype.filter),v=d(Array.prototype.pop),g=d(Array.prototype.join),E=d(Array.prototype.concat),R=d(RegExp.prototype.test),F=d(String.prototype.includes),S=["Infinity","NaN","undefined"],x=["isFinite","isNaN","parseFloat","parseInt","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","Array","ArrayBuffer","Boolean","DataView","EvalError","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Map","Number","Object","RangeError","ReferenceError","Set","String","Symbol","SyntaxError","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","URIError","WeakMap","WeakSet","JSON","Math","Reflect","escape","unescape"],$=["Date","Error","Promise","Proxy","RegExp","Intl"];function O(){const{defineProperty:t,defineProperties:e,getOwnPropertyDescriptor:n,getPrototypeOf:r,prototype:o}=Object;try{(0,o.__lookupGetter__)("x")}catch(t){return}function a(t){if(void 0===t||null===t)throw new TypeError("can't convert undefined or null to object");return Object(t)}function c(t){return"symbol"==typeof t?t:`${t}`}function i(t,e){if("function"!=typeof t)throw TypeError(`invalid ${e} usage`);return t}e(o,{__defineGetter__:{value:function(e,n){const r=a(this);t(r,e,{get:i(n,"getter"),enumerable:!0,configurable:!0})}},__defineSetter__:{value:function(e,n){const r=a(this);t(r,e,{set:i(n,"setter"),enumerable:!0,configurable:!0})}},__lookupGetter__:{value:function(t){let e,o=a(this);for(t=c(t);o&&!(e=n(o,t));)o=r(o);return e&&e.get}},__lookupSetter__:{value:function(t){let e,o=a(this);for(t=c(t);o&&!(e=n(o,t));)o=r(o);return e&&e.set}}})}function _(){const{defineProperties:t,getPrototypeOf:e,setPrototypeOf:n}=Object;function r(e,r){let o;try{o=(0,eval)(r)}catch(t){if(t instanceof SyntaxError)return;throw t}const a=FunctionPrototype.constructor;const c=function(){if(function(){const t=(new Error).stack;return!t||-1!==t.indexOf("eval")}())throw new TypeError("Not available");return a.apply(this,arguments)};t(c,{name:{value:e}}),t(FunctionPrototype,{constructor:{value:c}}),t(c,{prototype:{value:FunctionPrototype}}),c!==Function.prototype.constructor&&n(c,Function.prototype.constructor)}r("Function","(function(){})"),r("GeneratorFunction","(function*(){})"),r("AsyncFunction","(async function(){})"),r("AsyncGeneratorFunction","(async function*(){})")}const A="'use strict'; this",P="(0, eval)(\"'use strict'; this\")";const k=()=>{const t=function(){if("undefined"==typeof document)return;const t=document.createElement("iframe");return t.style.display="none",document.body.appendChild(t),t.contentWindow.eval(A)}(),e=function(){if(new Function("try {return this===global}catch(e){return false}")())return(new Symbol).runInNewContext(P)}();if(!t&&!e||t&&e)throw new Error("unexpected platform, unable to create Realm");return t||e};function j(t,n=[]){const r=function(t){const n={};function r(r,o,a,c){for(const i of r){const r=u(t,i);r&&(e("value"in r,`unexpected accessor on global property: ${i}`),n[i]={value:r.value,writable:o,enumerable:a,configurable:c})}}return r(S,!1,!1,!1),r(x,!1,!1,!1),r($,!0,!1,!0),n}(t);return i({unsafeGlobal:t,sharedGlobalDescs:r,unsafeEval:t.eval,unsafeFunction:t.Function,allShims:n})}const G=n(`"use strict"; (${O})();`),I=n(`"use strict"; (${_})();`);const U=/^[a-zA-Z_$][\w$]*$/,T=new Set(["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","export","extends","finally","for","function","if","import","in","instanceof","new","return","super","switch","this","throw","try","typeof","var","void","while","with","yield","let","static","enum","implements","package","protected","interface","private","public","await","null","true","false","this","arguments"]);const C=i({});new Proxy(i({}),{get(e,n){t(`unexpected scope handler trap called: ${n}`)}});const N=new RegExp("(?:\x3c!--|--\x3e)");const D=/\bimport\s*(?:\(|\/[/*])/;const W=/\beval\s*(?:\(|\/[/*])/;function M(t){!function(t){const e=t.search(N);if(-1!==e){const n=t.slice(0,e).split("\n").length;throw new SyntaxError(`possible html comment syntax rejected around line ${n}`)}}(t),function(t){const e=t.search(D);if(-1!==e){const n=t.slice(0,e).split("\n").length;throw new SyntaxError(`possible import expression rejected around line ${n}`)}}(t),function(t){const e=t.search(W);if(-1!==e){const n=t.slice(0,e).split("\n").length;throw new SyntaxError(`possible direct eval expression rejected around line ${n}`)}}(t)}const z={rewrite:t=>(M(t.src),t)};function B(t,e){const{unsafeFunction:n}=t;return n(`\n    with (arguments[0]) {\n      ${function(t){return 0===t.length?"":`const {${g(t,",")}} = this;`}(e)}\n      return function() {\n        'use strict';\n        return eval(arguments[0]);\n      };\n    }\n  `)}function J(n,r,o,a){const{unsafeFunction:i}=n,u=function(t){const e=l(t);return b(f(e),t=>{if("eval"===t||T.has(t)||!R(U,t))return!1;const n=e[t];return!1===n.configurable&&!1===n.writable&&w(n,"value")})}(r),h=B(n,u);return function(u={},f={}){const d=[...f.transforms||[],...o||[],...[z]],b={eval(e){e=`${e}`;const o=d.reduce((t,e)=>e.rewrite?e.rewrite(t):t,{src:e,endowments:u});e=o.src;const i=c(r,l(o.endowments)),s=function(t,e,n){const{unsafeGlobal:r,unsafeEval:o}=t;let a=!1;return{__proto__:C,allowUnsafeEvaluatorOnce(){a=!0},unsafeEvaluatorAllowed:()=>a,get:(t,e)=>"eval"===e?!0===a?(a=!1,o):t.eval:e!==Symbol.unscopables&&e in t?t[e]:void 0,set(t,n,r){if(w(t,n))throw new TypeError(`do not modify endowments like ${String(n)}`);return e[n]=r,!0},has:(t,e)=>!!n||"eval"===e||e in t||e in r}}(n,r,a),f=new Proxy(i,s),p=m(h,r,[f]);let y;s.allowUnsafeEvaluatorOnce();try{return m(p,r,[e])}catch(t){throw y=t,t}finally{s.unsafeEvaluatorAllowed()&&t("handler did not revoke useUnsafeEvaluator",y)}}}.eval;return y(b,i.prototype),e(p(b).constructor!==Function,"hide Function"),e(p(b).constructor!==i,"hide unsafeFunction"),s(b,{toString:{value:b("() => 'function eval' + '() { [shim code] }'"),writable:!1,enumerable:!1,configurable:!0}}),b}}const K=new WeakMap;function V(t){return e(Object(t)===t,"bad object, not a Realm instance"),e(K.has(t),"Realm instance has no record"),K.get(t)}function Z(t,n){e(Object(t)===t,"bad object, not a Realm instance"),e(!K.has(t),"Realm instance already has a record"),K.set(t,n)}function q(t,n,r){const{sharedGlobalDescs:o,unsafeGlobal:a}=t,u=c(a.Object.prototype,o),l=J(t,u,n,r),f=function(t){return t()}(l),m=function(t){return(e,n,r={})=>t(n,r)(e)}(l),h=function(t,n){const{unsafeFunction:r,unsafeGlobal:o}=t,a=function(...t){const e=`${v(t)||""}`;let a=`${g(t,",")}`;if(!R(/^[\w\s,]*$/,a))throw new o.SyntaxError("shim limitation: Function arg must be simple ASCII identifiers, possibly separated by commas: no default values, pattern matches, or non-ASCII parameter names");if(new r(e),F(a,")"))throw new o.SyntaxError("shim limitation: Function arg string contains parenthesis");return a.length>0&&(a+="\n/*``*/"),n(`(function(${a}){\n${e}\n})`)};return y(a,r.prototype),e(p(a).constructor!==Function,"hide Function"),e(p(a).constructor!==r,"hide unsafeFunction"),s(a,{prototype:{value:r.prototype},toString:{value:n("() => 'function Function() { [shim code] }'"),writable:!1,enumerable:!1,configurable:!0}}),a}(t,f);return function(t,e,n){s(t,{eval:{value:e,writable:!0,configurable:!0},Function:{value:n,writable:!0,configurable:!0}})}(u,f,h),i({safeGlobal:u,safeEval:f,safeEvalWhichTakesEndowments:m,safeFunction:h})}const H={initRootRealm:function(t,e,n){const{shims:r,transforms:a,sloppyGlobals:c}=n,i=E(t.allShims,r),s=function(t){const e=k();return e.eval(G),e.eval(I),j(e,t)}(i),u=function(t,e){const{unsafeEval:n}=t;return n(o)(t,e)}(s,H);s.sharedGlobalDescs.Realm={value:u,writable:!0,configurable:!0};const l=q(s,a,c),{safeEvalWhichTakesEndowments:f}=l;for(const t of i)f(t);Z(e,l)},initCompartment:function(t,e,n={}){const{transforms:r,sloppyGlobals:o}=n;Z(e,q(t,r,o))},getRealmGlobal:function(t){const{safeGlobal:e}=V(t);return e},realmEvaluate:function(t,e,n={},r={}){const{safeEvalWhichTakesEndowments:o}=V(t);return o(e,n,r)}};return r(function(){const t=(0,eval)(A);return O(),_(),j(t)}(),H)});